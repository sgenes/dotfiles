#!/usr/bin/env python3
import os
import datetime
from urllib.request import urlopen
import json

CACHE = os.path.join(os.path.expanduser('~/.cache'), 'weather.json')
SUNRISE = os.path.join(os.path.expanduser('~/.cache'), 'sunrise')
SUNSET = os.path.join(os.path.expanduser('~/.cache'), 'sunset')

def get_weather():
    sunrise = '5'
    sunset = '18'
    try:
        url = 'http://api.openweathermap.org/data/2.5/weather?lat=-6.92&lon=107.6&units=metric&appid=4f93c929afe2089d562f152a0f4fe75d'
        urlopened = urlopen(url)
        data = urlopened.read().decode('utf8')
        cacher = open(CACHE, 'w')
        cacher.write(data)
    except IOError:
        try:
            cacher = open(CACHE, 'r')
            data = cacher.read()
        except IOError:
            cacher = open(CACHE, 'w')
            cacher.write('')
            cacher.close
            cacher = open(CACHE, 'r')
            data = cacher.read()
    try:
        j = json.loads(data)
        try:
            sunrise = datetime.datetime.fromtimestamp(
                int(j['sys']['sunrise'])).strftime('%H')
            sunset = datetime.datetime.fromtimestamp(
                int(j['sys']['sunset'])).strftime('%H')
        except KeyError:
            sunrise = '5'
            sunset = '18'
    except ValueError:
        sunrise = '5'
        sunset = '18'
    sunriser = open(SUNRISE, 'w')
    sunriser.write(sunrise)
    sunsetter = open(SUNSET, 'w')
    sunsetter.write(sunset)
    sunriser.close
    sunsetter.close
    return (int(sunrise), int(sunset))


get_weather()
